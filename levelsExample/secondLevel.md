# STT (Speech To Text)

### Общее описание проекта
Проект используется для распознавания речи в браузере. Есть клиентская и серверная часть. Клиентская библиотека отвечает за запись
аудио с микрофона, отправляет байты со звуком через веб-сокет на серверную часть и принимает результат, переданный с сервера. Серверная чаcть общается со SpeechToText API,
которое уже непосредственно распознает звук, посредством GRPC. 

### API для работы с клиентской библиотекой
Пример работы показан ниже.  
```html
    <script type="text/javascript" src="https://static2.tinkoff.ru/portal/stt/speech_to_text_client_v1.0.2.js"></script>
    <script>
        const config = {
            wsUrl: 'wss://speech.tinkoff.ru'    // url, где находится сервер с вебсокетом
        };
        const speechToText = new SpeechToText(config);

        speechToText.startRecording(); // Начать запись. Будет запрошен доступ к микрофону пользователя
        
        speechToText.stopRecording(); // Закончить запись

        speechToText.onRecordingStart(() => {
            // Запись началась, доступ к микрофону получен
        });

        speechToText.onResult(payload => {
            const text = payload.results[0].alternatives[0].transcript;

            // Получен ответ от STT API
        });

        speechToText.onError(error => {
            // Произошла ошибка
        });

        speechToText.onEnd(() => {
            // Аудио полностью обработано
        });
    </script>
```

### Более подробно про API
Библиотека подключается скриптом, если вам нужен npm-пакет, напишите @a.a.sokolov.

Объект `speechToText` создается через конструктор `new SpeechToText(config)`. `config` представляет собой объект и содежит параметры:

`wsUrl` - адрес сервера с веб-сокетом. Пока есть только одно продовое окружение - `wss://speech.tinkoff.ru`

Методы созданного объекта:  
1. `startRecording()` - Начинает запись звука, предварительно спрашивая разрешение на использование микрофона,
если разрешение не было установлено ранее.  
2. `stopRecording()` - Останавливает запись звука. Когда весь кусок аудио будет обработан вызовется коллбэк `onEnd`
3. `onRecordingStart(callback)` - Подписка на начало непосредственной записи звука, особенно полезна может быть в случае, когда
изначально не было дано разрешение микрофону.
4. `onResult(callback)` - Подписка на удачно распознанный текст. Колбэк представляет собой функцию от одного аргумента, в
аргумент попадает распознанный текст (точнее, несколько вариантов). В колбэке можно выбрать подходящий вариант (например, выбираем
по длине текста).
5. `onError(callback)` - Подписка на ошибки. Колбэк представляет собой функцию от одного аргумента, в аргумент попадает объект с ошибкой. Объект с ошибкой содержит  `type` и `message` поля. `type` есть всегда, `message` может отсутствовать. Возможные значения `type`:
    1. `MICROPHONE_NOT_SUPPORTED`
    2. `MICROPHONE_BLOCKED`
    3. `WEB_SOCKET_CONNECTION_ABORTED` - ошибка соединения с веб-сокетом
    4. `STT_ERROR` - ошибка на стороне STT API
6. `onEnd(callback)` - Подписка на закрытие стрима. Вызывается тогда, когда API закрыло стрим. Например, мы вызвали `stopRecording()`,
API закрывает стрим и после этого срабатывает эта подписка.

* hello
* world Подписка на закрытие стрима. Вызывается тогда, когда API закрыло стрим. Например,
    1. no,not
    2. hello `sdsdsd`
    
1. hello
    - hello
    - not
2. world
    
Подписок на одинаковые события может быть много. В этом случае будут срабатывать все подписки со своими колбэками. Все методы подписок возвращают функцию отписки. Например:
```
    const errorSubscription = speechToText.onError(error => console.log(error)); // Подписались на ошибки
    errorSubscription(); // Отписались от ошибок
```

### Запуск локально
1. `npm run bootstrap`
2. `npm run start`

### Разработка 
1. запустить `npm run start:dev`

Предватирельно нужно создать файл .env со значениями:
`API_KEY` - случайная последовательность из 32 байт, закодированная в Base64 с опциональным суффиксом в виде произвольной строки из заглавных латинских букв  .

Пример: `zQWlSma1NEj0fC4AHyyY/fD0IfCR9jV/nXLNU7YuMhU=CALLTOUCH`

`SECRET_KEY` - случайная последовательность из 32 байт, закодированная в Base64

Пара (`API_KEY`, `SECRET_KEY`) — пара из API ключа и секретной части, хранящаяся в БД, использующаяся для подписи и верификации запросов

`STT_URL` - адрес API

### Основные файлы[](#api)
1. `source/js/SpeechtoText.js` - клиентская библиотека
2. `server/index.js` - серверная часть
3. `source/index.html` - демо-страница
4. `configs/server` переменные для сервера

### Переменные окружения
1. `API_KEY` - токен апи распознования речи
2. `SECRET_KEY` - секрет для подключения к серверу распознования речи
3. `SST_URL` - url серверна распознования речи

### Релиз
Обновляем версию в проекте
Обновляем описание
Обновляем параметры .env если нужно, через pf-deploys репозиторий. (Скачиваем репозиторий, вносим изменения, делаем ПР, просим девопсов смерджить). Изменения для .env обновляются при билде нашего проета.
Собираем и выкладываем на статику клиента чезер тимсити.
Деплоим
